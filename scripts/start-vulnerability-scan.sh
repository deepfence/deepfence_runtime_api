#!/bin/bash


usage () {

cat << EOF

	usage: $0 <options>

	OPTIONS:
        -h Show this message
        -l IP Address of this machine (Mandatory)
        -r IP Address of the machine having the management consle (Mandatory)
        -t Type of scan {base|java|nodejs|js|python|ruby|php|all}. (Mandatory)
        -i Image to be scanned, "host" if the entire host is to be scanned. (Mandatory)

EOF
}

l_flag=0
r_flag=0
PKT_CAP="N"

check_options () {
    if [ "$#" -lt 1 ]; then
        usage
    fi
    while getopts "l:r:t:i:h" opt; do
      case $opt in 
        h)
          usage
          exit 0
          ;;
        l) 
          MY_PUB_IP=$OPTARG
          l_flag=1
          ;;
        r)
          MGMT_CONSOLE_IP_ADDR=$OPTARG
          r_flag=1
          ;;
        i)
          IMAGE_NAME=$OPTARG
          i_flag=1
          ;;
        t)
          SCAN_TYPE=$OPTARG
          t_flag=1
          ;;
        *)
          usage
          exit 0
          ;;
      esac
    done
    if [ $l_flag == 0 ]; then
        usage
        exit 0
    fi
    if [ $r_flag == 0 ]; then
        usage
        exit 0
    fi
    if [ $i_flag == 0 ]; then
        usage
        exit 0
    fi
    if [ $t_flag == 0 ]; then
        usage
        exit 0
    fi
}


start_scan() {
    docker run -ti --net=host -v /var/run/docker.sock:/var/run/docker.sock -v /var/lib/docker/:/fenced/mnt/host/var/lib/docker/:rw -v /:/fenced/mnt/host/:ro -v deepfence_agent:/data:rw deepfenceio/deepfence_agent -a $MGMT_CONSOLE_IP_ADDR -l $MY_PUB_IP -f audit -t $SCAN_TYPE -i $IMAGE_NAME
}


main () {
    check_options "$@"
    start_scan
}

main "$@"

